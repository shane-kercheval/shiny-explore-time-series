---
title: "sandbox - time series"
author: "Shane Kercheval"
output:
    md_document:
    variant: markdown_github
toc: true
toc_depth: 4
---
    
```{r setup, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
library(knitr)

# library(lubridate)
# library(tidyverse)
# library(stringr)
# library(scales)
# library(ggrepel)
# library(rtools)

options(scipen=999) # non-scientific notation
```

```{r, echo=FALSE}
set.seed(41)
s <- seq(from = 1, to = 100, by = 1) + 10 + rnorm(100, sd = 7)
set.seed(42)
t <- seq(from = 1, to = 100, by = 1) + 10 + rnorm(100, sd = 7)

t
plot(t)
```

```{r, echo=FALSE}
temp <- cbind(ts(s), ts(t))

temp[, 1]
```



```{r, echo=FALSE}
ts(t, start=2000, frequency = 12)
```

```{r, echo=FALSE}
tseries <- ts(t, start=2000, frequency = 4)
tseries
```

```{r, echo=FALSE}
plot(tseries)
```

```{r, echo=FALSE}
library(fpp2)
library(rtools)


class(a10)

as.matrix(a10)


data.frame(Y=as.matrix(a10), date=time(a10))

dataset <- a10
dataset <- melsyd
dataset <- elecdemand

colnames(elecdemand)

rt_explore_plot_correlations(as.data.frame(dataset))

asdf <- function(dataset) {
    
    categoric_dataset <- as.data.frame(dataset) %>% select_if(Negate(is.numeric))
    if(ncol(categoric_dataset) == 0) {

        return (data.frame())

    } else {

        return (rt_explore_categoric_summary(categoric_dataset))
    }
}

asdf(dataset)

library(dplyr)
rt_explore_numeric_summary(as.data.frame(dataset) %>% select_if(is.numeric))

categoric_dataset <- as.data.frame(dataset) %>% select_if(Negate(is.numeric))
ncol()
rt_explore_categoric_summary()

```


```{r}

paste0(start(dataset), collapse = ', ')
paste0(end(dataset), collapse = ', ')
frequency(dataset)

??seasonal.periods

attr(dataset,'methods')
showMethods(classes="msts")

pretty_dataset <- function(dataset) {

    classes <- class(dataset)
    if(length(classes) == 1 && classes == 'ts') {

        return (data.frame(date=time(dataset), value=as.matrix(dataset)))
        
    } else if (any(classes == 'mts') || any(classes == 'msts')) {
        
        return (cbind(data.frame(date = time(dataset)), as.data.frame(dataset)))
        
    } else {
        
        stopifnot(FALSE)
    }
}
pretty_dataset(dataset)
pretty_dataset(dataset=a10)
pretty_dataset(dataset=melsyd)
prett

class(a10)
any(class(melsyd) == 'mts')
class(visnights)


library(ggplot2)
#install.packages('ggfortify')
#install.packages('zoo')
library(ggfortify)
library(scales)
time(tseries)

visnights %>%
#    zoo() %>%
autoplot() +
    ggtitle('Autoplot') +
    xlab('Year') #+
    #scale_x_discrete(breaks=x_output$timestamp[brks])
    #scale_x_continuous(breaks=2000:2024) 
    #scale_x_date(breaks = date_breaks("year"), labels = date_format("%Y")) +
   # scale_x_date(breaks = date_breaks("5 years"), minor_breaks = date_breaks("1 years"), labels = date_format("%Y")) +
    #theme(axis.text.x = element_text(angle = 30, hjust = 1))
#    scale_x_yearqtr()


min(visnights)
min(melsyd, na.rm = TRUE)
```

```{r}
rt_explore_numeric_summary(a10)
rt_explore_numeric_summary(visnights)
rt_explore_correlations(visnights)

rt_explore_plot_time_series(a10)
```

```{r, echo=FALSE}
#install.packages('fpp2')
#library(fpp2)

a10
melsyd[!is.na(melsyd[, 'First.Class']), 'First.Class']
melsyd[, 'First.Class']
ts(melsyd[, 'First.Class'])

colnames(a10)
colnames(melsyd)


colnames(a10)
colnames(melsyd[, 'First.Class'])
as.numeric(a10)
as.numeric(melsyd[, 'First.Class'])

class(a10) == 'ts'
class(melsyd[, 'First.Class']) == 'ts'

as.data.frame()

is_ts <- function(x) {
    any(class(x) == 'ts')
}
temp <- as.data.frame(melsyd) 
attr(melsyd, "ts_type") <- 'single'
attr(melsyd, "ts_type")

any(class(melsyd[, 'First.Class']) == 'ts')


typeof(a10)
typeof(melsyd[, 'First.Class'])

start(elecdemand)
end(elecdemand)

dim(a10)
dim(melsyd[, 'First.Class'])
window(melsyd[, 'First.Class'], start=c(1990, 0))
window(melsyd[, 'First.Class'], start=NULL, end=NULL)

melsyd


window(melsyd[, 'First.Class'], start=1990, end=NULL)

s <- start(temp)
e <- end(temp[, 1])
f <- frequency(temp[, 1])
ts(as.numeric(temp[, 1]), start=s, end=e, frequency=4)

#temp[, 1] %>%
ts(as.numeric(temp[, 1]), start=s, end=e, frequency=f) %>%
#melsyd[, 'First.Class'] %>%
#window(start=c(1990, 0)) %>%
#a10 %>%
temp %>%
    autoplot() +
    ggtitle('Autoplot') 
#    xlab('') 
    #scale_x_discrete(breaks=x_output$timestamp[brks])
    #scale_x_continuous(breaks=0:100) 
    #scale_x_date(date_breaks = "1 year")
    scale_x_date(breaks = date_breaks("1 years"), labels = date_format("%Y"))
    #scale_x_date(breaks = c(198))


, labels = date_format("%Y")) +
    #scale_x_date(breaks = date_breaks("5 years"), minor_breaks = date_breaks("1 years"), labels = date_format("%Y")) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1))
#    scale_x_yearqtr()
```


```{r}
beer_data <- ausbeer
beer_data <- window(beer_data, start=1992, end=c(2007, 4))

autoplot(beer_data) +
    autolayer(meanf(beer_data, h=11), series='Mean', PI=FALSE)

```

```{r}
dataset <- a10
forecast_model <- forecast(dataset, h=24)
comment(forecast_model) <- 'Forecast'

model_list <- list(forecast_model)
forecast_model <- naive(dataset, h=6)
comment(forecast_model) <- 'Naive'
#residuals(forecast_model)
model_list <- c(model_list, list(forecast_model))


resid_stats <- map(model_list, ~ {
    resids <- residuals(.)
    resid_mean <- mean(resids, na.rm = TRUE)
    resid_stan_dev <- sd(resids, na.rm = TRUE)
        
    return (data.frame(Model=comment(.),
                       Mean=resid_mean,
                       `Standard Deviation`=resid_stan_dev,
                       `Coefficient of Variation`=resid_stan_dev / resid_mean))
})

resid_stats_df <- do.call("rbind", resid_stats)
colnames(resid_stats_df) <- str_replace_all(colnames(resid_stats_df), '\\.', ' ')
resid_stats_df
```


```{r}
library(forecast)

dataset <- a10
forecast_model <- forecast(dataset, h=24)

s <- start(forecast_model$mean)
e <- end(forecast_model$mean)
f <- frequency(forecast_model$mean)

df_forecast_model <- as.data.frame(forecast_model)
ts_forecast <- ts(df_forecast_model$`Point Forecast`, start = s, end=e, frequency = f)

dataset %>%
    autoplot() + 
    autolayer(forecast_model,
              series='Auto',
              PI=TRUE) + 
    geom_point() +
    geom_text(aes(label=round(as.numeric(dataset), 0)), check_overlap=TRUE, vjust=1, hjust=1) +
    geom_point(data= ts_forecast) + 
    geom_text(data= ts_forecast, aes(label=round(ts_forecast, 1)), check_overlap=TRUE, vjust=0, hjust=0, color='blue')

```

```{r}
monthdays(milk)
frequency(milk) # 12 month

monthdays(ausbeer)
frequency(ausbeer) #  4 quarter

monthdays(melsyd)
frequency(melsyd) #  weekly


dframe <- cbind(Monthly = milk, 
                DailyAverage= milk / mont)



create_daily_average <- function(dataset) {
    
    freq <- frequency(dataset)
    
    if(freq == 12 || freq == 4) {  # monthly or quarterly

        return (dataset / monthdays(dataset))

    } else if (freq == 52) {  # weekly
    
        return (dataset / 7)

    } else {

        stopifnot(FALSE)
    }
}

create_daily_average(milk)
create_daily_average(ausbeer)
create_daily_average(melsyd)

log(milk+1, base=exp(1))
log(milk+1, base=2)


lambda <- BoxCox.lambda(milk)
BoxCox(milk, lambda = lambda)
```

```{r}
cv_mse <- function(cv_result) {

    return (colMeans(cv_result^2, na.rm = TRUE))
}

cv_rmse <- function(cv_result) {

    return (map_dbl(cv_mse(cv_result), ~ sqrt(.)))
}

cv_mae <- function(cv_result) {
    
    return (colSums(abs(cv_result), na.rm = TRUE) / nrow(cv_result))
}

cv_result <- tsCV(milk, forecastfunction = naive, h=8)
results <- rbind(NULL, cv_mae(cv_result))

cv_result <- tsCV(milk, forecastfunction = rwf, drift=TRUE, h=8)
results <- rbind(results, cv_mae(cv_result))
steps_ahead <- colnames(results)
results <- as.data.frame(results)

results$method <- c('rwf', 'naive')

results %>% 
    gather(key, value, -method) %>%
    mutate(key = factor(key, levels = steps_ahead)) %>%
    ggplot(aes(x=key, y=value, color=method, group=method)) +
        geom_line() +
        geom_point() +
        ylab('MAE') + xlab('Steps Ahead') +
        geom_text(aes(label=round(value, 1)), check_overlap=TRUE, vjust=1, hjust=1)
```

```{r}
tsCV(goog200, forecastfunction = rwf, drift=TRUE, lambda=1, h=8)
tsCV(goog200, forecastfunction = rwf, drift=TRUE, lambda=0, h=8)
```

```{r}
lm_results <- tslm(Consumption ~ Income, data=uschange)
summary(lm_results)
```

```{r}
lm_results <- tslm('Consumption ~ Income', data=uschange)
summary(lm_results)
```

```{r}
?marathon
fitted(forecast(goog))
```











